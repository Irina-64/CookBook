{% extends "main/base.html" %}

{% block page_title %}
  <h1>{% if editing %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç{% else %}–î–æ–±–∞–≤–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç{% endif %}</h1>
{% endblock %}

{% block content %}

  <div class="form-container">
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã -->
    {% if form.errors %}
      <div class="alert alert-danger">
        <h5>–û—à–∏–±–∫–∏ –≤ —Ñ–æ—Ä–º–µ:</h5>
        {{ form.errors }}
      </div>
    {% endif %}
    
    {% if formset.non_form_errors %}
      <script>
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –æ—à–∏–±–∫–∏ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
        document.addEventListener('DOMContentLoaded', function() {
          {% for error in formset.non_form_errors %}
            const errorText = "{{ error|escapejs }}";
            console.log('Error text:', errorText);
            if (errorText.includes('–¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑')) {
              // –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
              const match = errorText.match(/–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã '([^']+)'/);
              if (match) {
                const duplicateNames = match[1];
                showInfoModal(
                  '–î—É–±–ª–∏–∫–∞—Ç –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞',
                  `‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ: –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã "${duplicateNames}" –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑. –£–¥–∞–ª–∏—Ç–µ –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã.`
                );
              }
            }
          {% endfor %}
        });
      </script>
    {% endif %}
    
    {% if formset.errors %}
      <!-- –û—à–∏–±–∫–∏ –ø–æ–ª–µ–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å–∫—Ä—ã—Ç—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
    {% endif %}
    
    {% if image_formset.non_form_errors %}
      <!-- –û—à–∏–±–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–∫—Ä—ã—Ç—ã -->
    {% endif %}
    
    {% if image_formset.errors %}
      <!-- –û—à–∏–±–∫–∏ –ø–æ–ª–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–∫—Ä—ã—Ç—ã -->
    {% endif %}
      
      <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è —Ä–µ—Ü–µ–ø—Ç–∞ -->
      <div class="form-group">
        <label for="{{ form.title.id_for_label }}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ *</label>
        {{ form.title }}
      </div>
      
      <div class="form-group">
        <label for="{{ form.description.id_for_label }}">–û–ø–∏—Å–∞–Ω–∏–µ</label>
        {{ form.description }}
      </div>
      
      <div class="form-group">
        <label for="{{ form.instruction.id_for_label }}">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è *</label>
        {{ form.instruction }}
      </div>
      
      <div style="display: flex; gap: 20px;">
        <div class="form-group" style="flex: 1;">
          <label for="{{ form.cook_time.id_for_label }}">–í—Ä–µ–º—è –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (–º–∏–Ω) *</label>
          {{ form.cook_time }}
        </div>
        
        <div class="form-group" style="flex: 1;">
          <label for="{{ form.category.id_for_label }}">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          {{ form.category }}
        </div>
        
        <div class="form-group" style="flex: 1;">
          <label for="{{ form.difficulty.id_for_label }}">–°–ª–æ–∂–Ω–æ—Å—Ç—å</label>
          {{ form.difficulty }}
        </div>
      </div>

      <!-- –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã -->
      <h3 style="margin-top: 30px; color: #343a40;">ü•ò –ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã</h3>
    {{ formset.management_form }}
    <div id="ingredient-list">
      {% for subform in formset %}
          <div class="form-row" data-form-index="{{ forloop.counter0 }}">
            {{ subform.id }}
            {% if subform.errors %}
              <!-- –û—à–∏–±–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ —Å–∫—Ä—ã—Ç—ã -->
            {% endif %}
            <div class="form-group">
              <label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç *</label>
              <div style="display: flex; gap: 10px; align-items: center;">
                <input type="hidden" name="{{ subform.ingredient.html_name }}" value="{{ subform.ingredient.value|default:'' }}" class="ingredient-id-input">
                <input type="text" class="ingredient-name-display" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç..." readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
                <button type="button" class="btn btn-outline-primary btn-sm select-ingredient" style="padding: 8px 12px;">üîç –í—ã–±—Ä–∞—Ç—å</button>
              </div>
            </div>
            <div class="form-group">
              <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
              {{ subform.amount }}
            </div>
            <div class="form-group">
              <label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
              {{ subform.unit }}
            </div>
            <button type="button" class="btn btn-danger btn-sm remove-ingredient" style="padding: 5px 10px; font-size: 12px;">üóë –£–¥–∞–ª–∏—Ç—å</button>
        </div>
      {% endfor %}
    </div>

      <div style="text-align: center; margin: 15px 0;">
        <button type="button" id="add-form" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</button>
      </div>

      <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
      <h3 style="margin-top: 30px; color: #343a40;">üì∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
    {{ image_formset.management_form }}
    <div id="image-list">
      {% for imgform in image_formset %}
          <div class="image-form-row" data-form-index="{{ forloop.counter0 }}">
          {{ imgform.id }}
            {% if imgform.errors %}
              <!-- –û—à–∏–±–∫–∏ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–æ—Ä–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å–∫—Ä—ã—Ç—ã -->
            {% endif %}
            <div class="form-group">
              <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
          {{ imgform.image }}
            </div>
            <button type="button" class="btn btn-danger btn-sm remove-image" style="padding: 5px 10px; font-size: 12px; margin-top: 10px;">üóë –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
        </div>
      {% endfor %}
    </div>

      <div style="text-align: center; margin: 15px 0;">
        <button type="button" id="add-image-form" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
      </div>

      <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
      <div class="form-buttons">
        <button type="submit" class="btn btn-primary" onclick="cleanEmptyIngredientForms()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç</button>
        <a href="{% url 'recipe_list' %}" class="btn btn-secondary">‚ùå –û—Ç–º–µ–Ω–∞</a>
      </div>
  </form>
  </div>

  <!-- –®–∞–±–ª–æ–Ω –ø—É—Å—Ç–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ -->
  <template id="empty-form-template">
    <div class="form-row" data-form-index="__prefix__">
      <input type="hidden" name="ingredients-__prefix__-id">
      <div class="form-group">
        <label>–ò–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç *</label>
        <div style="display: flex; gap: 10px; align-items: center;">
          <input type="hidden" name="ingredients-__prefix__-ingredient" class="ingredient-id-input">
          <input type="text" class="ingredient-name-display" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç..." readonly style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f8f9fa;">
          <button type="button" class="btn btn-outline-primary btn-sm select-ingredient" style="padding: 8px 12px;">üîç –í—ã–±—Ä–∞—Ç—å</button>
        </div>
      </div>
      <div class="form-group">
        <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ *</label>
        {{ formset.empty_form.amount }}
      </div>
      <div class="form-group">
        <label>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è *</label>
        {{ formset.empty_form.unit }}
      </div>
      <button type="button" class="btn btn-danger btn-sm remove-ingredient" style="padding: 5px 10px; font-size: 12px;">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </template>

  <!-- –®–∞–±–ª–æ–Ω –ø—É—Å—Ç–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
  <template id="empty-image-template">
    <div class="image-form-row" data-form-index="__prefix__">
      <input type="hidden" name="images-__prefix__-id">
      <div class="form-group">
        <label>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
        <input type="file" name="images-__prefix__-image" accept="image/*">
      </div>
      <button type="button" class="btn btn-danger btn-sm remove-image" style="padding: 5px 10px; font-size: 12px; margin-top: 10px;">üóë –£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</button>
    </div>
  </template>

  <!-- Fallback –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–æ–≤ (–µ—Å–ª–∏ AJAX –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç) -->
  {% include 'recipes/ingredient_fallback.html' %}
  <div id="ingredientModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 500px; margin: 50px auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
      <div style="margin-bottom: 20px;">
        <h3 style="margin: 0; color: #007bff; text-align: center;">üîç –í—ã–±—Ä–∞—Ç—å –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</h3>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" onclick="switchToFallback()" 
                  style="background: #28a745; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px;">
            üìã –ü—Ä–æ—Å—Ç–æ–π –≤—ã–±–æ—Ä
          </button>
        </div>
      </div>
      
      <div class="form-group">
        <label>–ü–æ–∏—Å–∫ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:</label>
        <input type="text" id="ingredientSearch" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
      </div>
      
      <div id="ingredientResults" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
      </div>
      
      <div id="createNewIngredient" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 4px;">
        <h5 style="margin-bottom: 10px; color: #007bff;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç</h5>
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:</label>
          <input type="text" id="newIngredientName" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞..." style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
        </div>
        <div style="text-align: center; margin-top: 10px;">
          <button type="button" onclick="createNewIngredient()" class="btn btn-success btn-sm">–°–æ–∑–¥–∞—Ç—å</button>
          <button type="button" onclick="hideCreateNew()" class="btn btn-secondary btn-sm">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 20px;">
        <button type="button" onclick="showCreateNew()" class="btn btn-outline-primary btn-sm" style="margin-right: 10px;">‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</button>
        <button type="button" onclick="closeIngredientModal()" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
      </div>
    </div>
  </div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
    {% if editing %}
    loadExistingIngredients();
    {% endif %}
});

function loadExistingIngredients() {
    const ingredientInputs = document.querySelectorAll('.ingredient-id-input');
    const ingredientDisplays = document.querySelectorAll('.ingredient-name-display');
    
    ingredientInputs.forEach((input, index) => {
        const ingredientId = input.value;
        const display = ingredientDisplays[index];
        
        if (ingredientId) {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ AJAX
            fetch(`/recipes/api/ingredient-name/${ingredientId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.name) {
                        display.value = data.name;
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç–∞:', error);
                });
        }
    });
}
</script>
{% endblock %}

